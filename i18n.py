from __future__ import annotations

from typing import Dict

LANG_LABELS = {
    "zh": "繁體中文",
    "en": "English",
    "ja": "日本語",
}

TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "zh": {
        "app_title": "電子交接本系統",
        "login": "登入",
        "username": "帳號",
        "password": "密碼",
        "login_button": "登入",
        "login_failed": "帳號或密碼錯誤",
        "login_error": "登入失敗：{msg}",
        "login_success": "登入成功",
        "logout": "登出",
        "nav": "導航",
        "nav_daily_entry": "填寫日報",
        "nav_report_view": "歷史查詢",
        "nav_user_mgmt": "使用者管理",
        "nav_change_password": "修改密碼",
        "only_admin": "只有管理員可以存取此功能。",
        "need_login": "請先登入。",
        "user_label": "使用者",
        "role_label": "角色",
        "language": "語言",
        "daily_entry": "日報填寫",
        "date": "日期",
        "shift": "班別",
        "area": "區域",
        "attendance": "出勤狀況",
        "attendance_category": "分類",
        "scheduled_count": "定員",
        "present_count": "出勤",
        "absent_count": "欠勤",
        "reason": "理由",
        "equipment": "設備異常",
        "equip_id": "設備番号",
        "description": "異常內容",
        "start_time": "發生時刻",
        "impact_qty": "影響數量",
        "action_taken": "對應內容",
        "lots": "本日異常批次",
        "lot_id": "批號",
        "status": "處置狀況",
        "notes": "特記事項",
        "summary": "總結",
        "key_output": "關鍵產出 (Key Machine Output)",
        "key_issues": "關鍵問題 (Key Issues)",
        "countermeasures": "對策 (Countermeasures)",
        "upload_photos": "上傳照片 (可多選)",
        "submit": "提交",
        "submit_success": "提交成功！",
        "submit_fail": "提交失敗：{msg}",
        "save_image_fail": "保存圖片失敗：{msg}",
        "validation_fail": "提交失敗：\n{msg}",
        "attendance_negative": "出勤第 {row} 列「{field}」不得為負數",
        "attendance_number": "出勤第 {row} 列「{field}」需為數字",
        "equipment_negative": "設備異常第 {row} 列「影響數量」不得為負數",
        "equipment_number": "設備異常第 {row} 列「影響數量」需為數字",
        "history": "歷史報表",
        "select_range": "選擇日期範圍",
        "area_all": "全部",
        "query": "查詢",
        "query_fail": "查詢失敗：{msg}",
        "no_data": "查無資料",
        "export_csv": "匯出 CSV",
        "change_password": "修改密碼",
        "old_password": "目前密碼",
        "new_password": "新密碼",
        "confirm_password": "確認新密碼",
        "password_mismatch": "新密碼與確認密碼不一致。",
        "password_incorrect": "目前密碼不正確。",
        "password_updated": "密碼已更新，請重新登入。",
        "password_update_fail": "更新密碼失敗：{msg}",
        "user_mgmt": "使用者管理",
        "existing_users": "現有使用者",
        "new_password_optional": "新密碼（留空則不變）",
        "update": "更新",
        "delete": "刪除",
        "confirm_delete": "確認刪除",
        "delete_warning": "請先勾選確認刪除。",
        "add_user": "新增使用者",
        "add": "新增",
        "add_success": "已新增使用者 {name}",
        "add_fail": "新增失敗：{msg}",
        "update_success": "已更新使用者 {name}",
        "update_fail": "更新失敗：{msg}",
        "delete_success": "已刪除使用者 {name}",
        "delete_fail": "刪除失敗：{msg}",
        "user_not_found": "找不到使用者資料。",
        "must_be_admin": "只有管理員可以管理使用者。",
        "area_options": "區域",
        "empty_user_pass": "帳號與密碼不可為空。",
        "username_exists": "帳號已存在。",
    },
    "en": {
        "app_title": "Handover System",
        "login": "Login",
        "username": "Username",
        "password": "Password",
        "login_button": "Login",
        "login_failed": "Invalid username or password",
        "login_error": "Login failed: {msg}",
        "login_success": "Logged in",
        "logout": "Logout",
        "nav": "Navigation",
        "nav_daily_entry": "Daily Entry",
        "nav_report_view": "Report History",
        "nav_user_mgmt": "User Management",
        "nav_change_password": "Change Password",
        "only_admin": "Admin only.",
        "need_login": "Please log in first.",
        "user_label": "User",
        "role_label": "Role",
        "language": "Language",
        "daily_entry": "Daily Entry",
        "date": "Date",
        "shift": "Shift",
        "area": "Area",
        "attendance": "Attendance",
        "attendance_category": "Category",
        "scheduled_count": "Scheduled",
        "present_count": "Present",
        "absent_count": "Absent",
        "reason": "Reason",
        "equipment": "Equipment Issues",
        "equip_id": "Equipment ID",
        "description": "Description",
        "start_time": "Start Time",
        "impact_qty": "Impact Qty",
        "action_taken": "Action Taken",
        "lots": "Abnormal Lots",
        "lot_id": "Lot ID",
        "status": "Handling Status",
        "notes": "Special Notes",
        "summary": "Summary",
        "key_output": "Key Machine Output",
        "key_issues": "Key Issues",
        "countermeasures": "Countermeasures",
        "upload_photos": "Upload photos (multiple allowed)",
        "submit": "Submit",
        "submit_success": "Submitted!",
        "submit_fail": "Submit failed: {msg}",
        "save_image_fail": "Saving images failed: {msg}",
        "validation_fail": "Submit failed:\n{msg}",
        "attendance_negative": "Attendance row {row} '{field}' cannot be negative",
        "attendance_number": "Attendance row {row} '{field}' must be a number",
        "equipment_negative": "Equipment row {row} 'Impact qty' cannot be negative",
        "equipment_number": "Equipment row {row} 'Impact qty' must be a number",
        "history": "Report History",
        "select_range": "Date Range",
        "area_all": "All",
        "query": "Search",
        "query_fail": "Query failed: {msg}",
        "no_data": "No data",
        "export_csv": "Export CSV",
        "change_password": "Change Password",
        "old_password": "Current Password",
        "new_password": "New Password",
        "confirm_password": "Confirm New Password",
        "password_mismatch": "New password and confirmation do not match.",
        "password_incorrect": "Current password is incorrect.",
        "password_updated": "Password updated, please log in again.",
        "password_update_fail": "Password update failed: {msg}",
        "user_mgmt": "User Management",
        "existing_users": "Existing Users",
        "new_password_optional": "New password (leave blank to keep)",
        "update": "Update",
        "delete": "Delete",
        "confirm_delete": "Confirm delete",
        "delete_warning": "Please check confirm delete first.",
        "add_user": "Add User",
        "add": "Add",
        "add_success": "User {name} added",
        "add_fail": "Add failed: {msg}",
        "update_success": "User {name} updated",
        "update_fail": "Update failed: {msg}",
        "delete_success": "User {name} deleted",
        "delete_fail": "Delete failed: {msg}",
        "user_not_found": "User not found.",
        "must_be_admin": "Admin only.",
        "area_options": "Area",
        "empty_user_pass": "Username and password are required.",
        "username_exists": "Username already exists.",
    },
    "ja": {
        "app_title": "電子引き継ぎシステム",
        "login": "ログイン",
        "username": "ユーザー名",
        "password": "パスワード",
        "login_button": "ログイン",
        "login_failed": "ユーザー名またはパスワードが違います",
        "login_error": "ログイン失敗: {msg}",
        "login_success": "ログインしました",
        "logout": "ログアウト",
        "nav": "ナビゲーション",
        "nav_daily_entry": "日報入力",
        "nav_report_view": "履歴照会",
        "nav_user_mgmt": "ユーザー管理",
        "nav_change_password": "パスワード変更",
        "only_admin": "管理者のみ利用できます。",
        "need_login": "先にログインしてください。",
        "user_label": "ユーザー",
        "role_label": "ロール",
        "language": "言語",
        "daily_entry": "日報入力",
        "date": "日付",
        "shift": "シフト",
        "area": "エリア",
        "attendance": "出勤状況",
        "attendance_category": "区分",
        "scheduled_count": "定員",
        "present_count": "出勤",
        "absent_count": "欠勤",
        "reason": "理由",
        "equipment": "設備異常",
        "equip_id": "設備番号",
        "description": "異常内容",
        "start_time": "発生時刻",
        "impact_qty": "影響数",
        "action_taken": "対処内容",
        "lots": "本日の異常ロット",
        "lot_id": "ロットID",
        "status": "処置状況",
        "notes": "特記事項",
        "summary": "サマリー",
        "key_output": "主要アウトプット",
        "key_issues": "主要課題",
        "countermeasures": "対策",
        "upload_photos": "写真アップロード（複数可）",
        "submit": "送信",
        "submit_success": "送信しました！",
        "submit_fail": "送信失敗: {msg}",
        "save_image_fail": "画像保存失敗: {msg}",
        "validation_fail": "送信失敗:\n{msg}",
        "attendance_negative": "出勤 {row} 行「{field}」は負の値にできません",
        "attendance_number": "出勤 {row} 行「{field}」は数値で入力してください",
        "equipment_negative": "設備異常 {row} 行「影響数」 は負の値にできません",
        "equipment_number": "設備異常 {row} 行「影響数」 は数値で入力してください",
        "history": "履歴照会",
        "select_range": "日付範囲",
        "area_all": "すべて",
        "query": "検索",
        "query_fail": "検索失敗: {msg}",
        "no_data": "データなし",
        "export_csv": "CSV エクスポート",
        "change_password": "パスワード変更",
        "old_password": "現在のパスワード",
        "new_password": "新しいパスワード",
        "confirm_password": "新しいパスワード（確認）",
        "password_mismatch": "新パスワードが一致しません。",
        "password_incorrect": "現在のパスワードが違います。",
        "password_updated": "パスワードを更新しました。再ログインしてください。",
        "password_update_fail": "更新失敗: {msg}",
        "user_mgmt": "ユーザー管理",
        "existing_users": "既存ユーザー",
        "new_password_optional": "新パスワード（空欄で変更なし）",
        "update": "更新",
        "delete": "削除",
        "confirm_delete": "削除確認",
        "delete_warning": "削除を確認してください。",
        "add_user": "ユーザー追加",
        "add": "追加",
        "add_success": "ユーザー {name} を追加しました",
        "add_fail": "追加失敗: {msg}",
        "update_success": "ユーザー {name} を更新しました",
        "update_fail": "更新失敗: {msg}",
        "delete_success": "ユーザー {name} を削除しました",
        "delete_fail": "削除失敗: {msg}",
        "user_not_found": "ユーザーが見つかりません。",
        "must_be_admin": "管理者のみ利用できます。",
        "area_options": "エリア",
        "empty_user_pass": "ユーザー名とパスワードは必須です。",
        "username_exists": "ユーザー名は既に存在します。",
    },
}


def get_locale() -> str:
    return current_locale if current_locale in TRANSLATIONS else "zh"


def t(key: str, *, locale: str | None = None, **kwargs: str) -> str:
    lang = locale if locale in TRANSLATIONS else get_locale()
    template = TRANSLATIONS.get(lang, {}).get(key, key)
    return template.format(**kwargs) if kwargs else template


def set_locale(locale: str) -> None:
    global current_locale
    current_locale = locale if locale in TRANSLATIONS else "zh"


current_locale = "zh"
